<!DOCTYPE html>
<html>
<head>
    <title>Live Debug</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Live Debug - Supabase Data Access</h1>
    <button onclick="runTest()" id="testBtn">Run Database Test</button>
    <pre id="output" style="background: #f0f0f0; padding: 20px; margin: 20px 0;"></pre>
    
    <script>
        const supabaseUrl = 'https://csuymzqibcyplpcwtfni.supabase.co'
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzdXltenFpYmN5cGxwY3d0Zm5pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyMTQyNTQsImV4cCI6MjA3Mjc5MDI1NH0.wg62oyYkI-pQ1uvzswYr2WobQQWL0LJyq-aiNgcsksU'
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey)
        
        function log(msg) {
            const output = document.getElementById('output')
            const time = new Date().toLocaleTimeString()
            output.textContent += `[${time}] ${msg}\n`
            console.log(msg)
        }
        
        async function runTest() {
            document.getElementById('testBtn').disabled = true
            document.getElementById('output').textContent = ''
            
            log('=== LIVE SUPABASE DEBUG ===')
            
            try {
                // 1. Check session
                log('1. Checking session...')
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession()
                
                if (sessionError) {
                    log(`❌ Session error: ${sessionError.message}`)
                    return
                }
                
                if (!sessionData?.session) {
                    log('❌ No session found - please sign in first!')
                    return
                }
                
                const user = sessionData.session.user
                log(`✅ Session OK - User: ${user.email} (${user.id})`)
                
                // 2. Test users table
                log('2. Testing users table...')
                const { data: usersData, error: usersError } = await supabase
                    .from('users')
                    .select('id, email, name')
                    .limit(5)
                
                if (usersError) {
                    log(`❌ Users table error: ${usersError.message}`)
                    log(`   Code: ${usersError.code || 'unknown'}`)
                    log(`   Details: ${usersError.details || 'none'}`)
                } else {
                    log(`✅ Users table OK - Found ${usersData?.length || 0} records`)
                }
                
                // 3. Test badges table
                log('3. Testing badges table...')
                const { data: badgesData, error: badgesError } = await supabase
                    .from('badges')
                    .select('id, name, description')
                    .limit(5)
                
                if (badgesError) {
                    log(`❌ Badges table error: ${badgesError.message}`)
                    log(`   Code: ${badgesError.code || 'unknown'}`)
                    log(`   Details: ${badgesError.details || 'none'}`)
                } else {
                    log(`✅ Badges table OK - Found ${badgesData?.length || 0} records`)
                }
                
                // 4. Test RPC function
                log('4. Testing get_user_stats RPC...')
                const { data: rpcData, error: rpcError } = await supabase.rpc('get_user_stats')
                
                if (rpcError) {
                    log(`❌ RPC function error: ${rpcError.message}`)
                    log(`   Code: ${rpcError.code || 'unknown'}`)
                    log(`   Details: ${rpcError.details || 'none'}`)
                } else {
                    log(`✅ RPC function OK - Data: ${JSON.stringify(rpcData)}`)
                }
                
                // 5. Test climb_logs table
                log('5. Testing climb_logs table...')
                const { data: logsData, error: logsError } = await supabase
                    .from('climb_logs')
                    .select('id, user_id')
                    .eq('user_id', user.id)
                    .limit(5)
                
                if (logsError) {
                    log(`❌ Climb_logs table error: ${logsError.message}`)
                    log(`   Code: ${logsError.code || 'unknown'}`)
                    log(`   Details: ${logsError.details || 'none'}`)
                } else {
                    log(`✅ Climb_logs table OK - Found ${logsData?.length || 0} user records`)
                }
                
                // 6. Test user_badges table
                log('6. Testing user_badges table...')
                const { data: userBadgesData, error: userBadgesError } = await supabase
                    .from('user_badges')
                    .select('user_id, badge_id')
                    .eq('user_id', user.id)
                    .limit(5)
                
                if (userBadgesError) {
                    log(`❌ User_badges table error: ${userBadgesError.message}`)
                    log(`   Code: ${userBadgesError.code || 'unknown'}`)
                    log(`   Details: ${userBadgesError.details || 'none'}`)
                } else {
                    log(`✅ User_badges table OK - Found ${userBadgesData?.length || 0} user records`)
                }
                
                log('=== TEST COMPLETE ===')
                
            } catch (error) {
                log(`❌ Unexpected error: ${error.message}`)
            }
            
            document.getElementById('testBtn').disabled = false
        }
    </script>
</body>
</html>